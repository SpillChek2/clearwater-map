(function(){"use strict";window.cwm={init:function(){var t="http://clearwater.cartodb.com/api/v2/sql?format=geojson&q=",e={bingApiKey:"Ajt-JIuGs7jVKkk4yeC5HWByvuHQ4OEISvzK2-77yRcz_EOCAGfooD4eDeZ-aY4l",mapboxId:"gmaclennan.map-y7pgvo15",startBounds:[{lat:-55,lon:-90},{lat:14,lon:-33}],communityUrl:t+"SELECT ST_Simplify(the_geom, 0.0002) AS the_geom, c.community, c.nationality, systems, users "+"FROM communities AS c LEFT JOIN (SELECT COUNT(*) AS systems, SUM(users) AS users, community "+"FROM clearwater_well_installations GROUP BY community) AS cwi ON c.community = cwi.community WHERE active",installationUrl:t+"SELECT * FROM clearwater_well_installations WHERE photo IS NOT NULL",padding:580},n=cwm.Map("map",e);cwm.Stories("stories").map(n)}},cwm.Map=function(t,e){function n(){d.bounds.communities&&c.bounds&&(o(),r(),i())}function o(){var t=c.getLocations(function(t){return cwm.util.sanitize(t.properties.featured_url)},function(t){return t.properties.featured&&!0});p=p.concat([{id:"overview",bounds:d.bounds.communities}]).concat(d.getLocations("community")).concat(t)}function r(){d3.selectAll("#"+t+" a").on("click",function(){void 0!==a&&a.scrollTo(this.getAttribute("href").split("#")[1])}),d3.selectAll(".markers circle").on("click",function(){function t(){var t=18,e=new MM.Point(d3.event.clientX,d3.event.clientY),n=m.pointCoordinate(e).zoomTo(t);m.ease.to(n).path("about").run(500,function(){m.easeHandler.setOverride()})}if(!d3.event.defaultPrevented){var e=this.getAttribute("data-link");e?a.scrollTo(e):t()}})}function i(){m.paddingLeft=u,m.easeHandler.locations(p).enable()}var a,s=0,u=e.padding||0,l=cwm.render.LayerContainer("layers"),c=cwm.layers.MarkerLayer(l,"markers"),d=cwm.layers.FeatureLayer(l,"features"),m=new MM.Map(t,[cwm.layers.BingLayer({apiKey:e.bingApiKey}),mapbox.layer().id(e.mapboxId),d,c],null,[cwm.handlers.DragHandler()]).setExtent(e.startBounds,!1,u).setZoomRange(3,18);d.add(cwm.data.ecuador,{id:"ecuador",maxZoom:7}).load(e.communityUrl,{id:"communities",maxZoom:13},n),c.load(e.installationUrl,{minZoom:13},n),m.ease=mapbox.ease().map(m),m.easeHandler=cwm.handlers.EaseHandler().map(m),m.stories=function(t){return a=t,m},m.addCallback("panned",function(t){t.easeHandler.setOverride()}),window.onresize=function(){$("html,body").stop(!0),Date.now()-s>1e3/30&&i(),s=Date.now()};var p=[{id:"ecuador",bounds:cwm.util.d3Bounds(e.startBounds)}];return m},cwm.Stories=function(){function t(){d3.selectAll('a[href*="#"]').on("click",function(){r.scrollTo(this.getAttribute("href").split("#")[1])}),d3.selectAll("#stories h1, #stories h2").on("click",function(){r.scrollTo($x(this).parent("section")[0].getAttribute("id"))})}var e,n,o,r={};t(),r.map=function(t){return n=t.stories(r),r};var i=document.getElementsByTagName("h1")[0].offsetHeight;return document.getElementsByTagName("h2")[0].offsetHeight,e=cwm.handlers.RevealHandler().affixTop("#stories h1",function(){return $x(this).parent("article").next().offsetTop()-this.offsetHeight}).affixBottom("#stories h2, #stories h1",function(){return $x(this).parent("section").previousSiblingOrCousin().offsetBottom()-window.innerHeight+this.offsetHeight}).fadeIn(".image",function(){return $x(this).offsetTop()-window.innerHeight},function(){return $x(this).offsetTop()-window.innerHeight+this.offsetHeight}).fadeOut("#stories article > section:not(:first-child)",function(){return $x(this).offsetTop()+this.offsetHeight-window.innerHeight},function(){return $x(this).offsetTop()+Math.max(window.innerHeight-i-this.offsetHeight,100)}).enable(),r.scrollTo=function(t){function e(t){return.5*(1-Math.cos(Math.PI*t))}function r(){var t=Date.now();t-d>i?(window.scroll(0,l),o=null):(window.scroll(0,u+c*e((t-d)/i)),o=requestAnimationFrame(r))}var i,a=document.getElementById(t),s=$x(a).nextSiblingOrCousin()[0].children[1].children[0].offsetHeight,u=window.pageYOffset,l=a?a.offsetTop+a.offsetHeight+s:u,c=Math.round(l-u),d=Date.now();0!==c&&(o&&cancelAnimationFrame(o),n?(n.easeHandler.clearOverride(),n.easeHandler.setOverride(null,null,Math.min(l,u),Math.max(l,u)),i=n.easeHandler.getOverrideTime()):i=4*Math.abs(c),r())},r},cwm.render={LayerContainer:function(t){var e=d3.select(document.body).append("div").style("position","absolute").style("width","100%").style("height","100%").attr("id",t);return e.append("svg").style("position","absolute"),e},Markers:function(t,e){return e.selectAll("circle").data(t).enter().append("circle").attr("r",0)},PopupWrapper:function(t,e){var n=e.append("div").attr("class","marker-tooltip").style("width","100%").datum(t);return n.append("div").style("position","absolute").style("pointer-events","none").append("div").attr("class","marker-popup").style("pointer-events","auto"),n},PopupSmall:function(t,e){return e.append("div").attr("class","wrapper").append("img").attr("src",t.properties.photo),e.append("p").text(t.properties.name.split(" and")[0]),e}},cwm.util={sanitize:function(t){return t!==void 0&&null!==t?t.toLowerCase().replace("http://www.giveclearwater.org/","a-").replace("http://beta.giveclearwater.org/","b-").split(" ").join("-").split("/").join("-"):void 0},preloadImages:function(t,e){_.forEach(t.features,function(t){if(e===t.properties.community){var n=new Image;n.src=t.properties.photo}})},fillArray:function(t,e){for(var n,o=[],r=t instanceof Array,i=0;e>i;i++)n=r?t.slice(0):t,o.push(n);return o},d3Bounds:function(t){return[[t[0].lon,t[0].lat],[t[1].lon,t[1].lat]]}},MM.getMousePoint=function(t){var e=new MM.Point(t.clientX,t.clientY);return e},MM.Map.prototype.centerFromBounds=function(t){var e=new MM.Extent(t[1][1],t[0][0],t[0][1],t[1][0]);return this.extentCoordinate(e,!0)},MM.Map.prototype.extentCoordinate=function(t,e,n){var n=this.paddingLeft||n||0;t instanceof MM.Extent&&(t=t.toArray());for(var o,r,i=0;t.length>i;i++){var a=this.projection.locationCoordinate(t[i]);o?(o.row=Math.min(o.row,a.row),o.column=Math.min(o.column,a.column),o.zoom=Math.min(o.zoom,a.zoom),r.row=Math.max(r.row,a.row),r.column=Math.max(r.column,a.column),r.zoom=Math.max(r.zoom,a.zoom)):(o=a.copy(),r=a.copy())}var s=this.dimensions.x+1-n,u=this.dimensions.y+1,l=(r.column-o.column)/(s/this.tileSize.x),c=Math.log(l)/Math.log(2),d=o.zoom-(e?c+.1:Math.ceil(c)),m=(r.row-o.row)/(u/this.tileSize.y),p=Math.log(m)/Math.log(2),f=o.zoom-(e?p+.1:Math.ceil(p)),h=Math.min(d,f);h=Math.min(h,this.coordLimits[1].zoom),h=Math.max(h,this.coordLimits[0].zoom);var y=(o.row+r.row)/2,g=(o.column+r.column)/2,w=o.zoom;return new MM.Coordinate(y,g,w).zoomTo(h).left(n/this.tileSize.x/2)},MM.Map.prototype.setExtent=function(t,e,n){return this.coordinate=this.extentCoordinate(t,e,n),this.draw(),this.dispatchCallback("extentset",t),this},MM.Layer.prototype.positionTile=function(t){var e=this.map.coordinate.zoomTo(t.coord.zoom);t.style.cssText="position:absolute;-webkit-user-select:none;-webkit-user-drag:none;-moz-user-drag:none;-webkit-transform-origin:0 0;-moz-transform-origin:0 0;-o-transform-origin:0 0;-ms-transform-origin:0 0;width:"+this.map.tileSize.x+"px; height: "+this.map.tileSize.y+"px;",t.ondragstart=function(){return!1};var n=Math.pow(2,this.map.coordinate.zoom-t.coord.zoom);MM.moveElement(t,{x:Math.round(this.map.dimensions.x/2+(t.coord.column-e.column)*this.map.tileSize.x*n),y:Math.round(this.map.dimensions.y/2+(t.coord.row-e.row)*this.map.tileSize.y*n),scale:n,width:this.map.tileSize.x,height:this.map.tileSize.y});var o=this.levels[t.coord.zoom];o.appendChild(t),t.className="map-tile-loaded",Math.round(this.map.coordinate.zoom)==t.coord.zoom&&(o.style.display="block"),this.requestRedraw()},function(t,e,n){"undefined"!=typeof module&&module.exports?module.exports=n():"function"==typeof define&&define.amd?define(n):e[t]=n()}("$x",this,function(){function t(e){return e?e.offsetTop+t(e.offsetParent):0}function e(t,o){return"HTML"==t.tagName||t.tagName==o.toUpperCase()?n(t):e(t.parentNode,o)}var n=function(t){return this instanceof n?(this[0]=t,void 0):new n(t)};return n.prototype={get:function(){return this[0]||null},next:function(){return n(this[0].nextElementSibling)},offsetTop:function(){return t(this[0])},offsetBottom:function(){return this[0]&&this[0].offsetHeight+t(this[0])},parent:function(t){return e(this[0],t)},previousSiblingOrCousin:function(){var t=this[0].parentNode.previousElementSibling;return n(this[0].previousElementSibling||t&&t.lastElementChild)},nextSiblingOrCousin:function(){var t=this[0].parentNode.nextElementSibling;return n(this[0].nextElementSibling||t&&t.firstElementChild)}},n}),cwm.layers={},cwm.layers.BingLayer=function(t){return this instanceof cwm.layers.BingLayer?(this._subdomains=[0,1,2,3],this._key=t.apiKey,this._style=t.style||"Aerial",this._url="",this.meta="",this.parent=document.createElement("div"),this.parent.style.cssText="position: absolute; top: 0px; left: 0px; width: 100%; height: 100%; margin: 0; padding: 0; z-index: 0",this.levels={},this.requestManager=new MM.RequestManager,this.requestManager.addCallback("requestcomplete",this.getTileComplete()),this.requestManager.addCallback("requesterror",this.getTileError()),this.setProvider(new wax.mm._provider({tiles:["data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"]})),this.loadMetadata(),void 0):new cwm.layers.BingLayer(t)},cwm.layers.BingLayer.prototype.initMetadata=function(){var t=this.meta.resourceSets[0].resources[0];this._subdomains=t.imageUrlSubdomains,this._url=t.imageUrl.replace("{subdomain}","{S}").replace("{quadkey}","{Q}").replace("http:",document.location.protocol).replace("{culture}",""),this.setProvider(new MM.Template(this._url,this._subdomains))},cwm.layers.BingLayer.prototype.loadMetadata=function(){var t=document.location.protocol+"//dev.virtualearth.net/REST/v1/Imagery/Metadata/"+this._style,e=this;$.ajax({url:t,data:{key:this._key},jsonp:"jsonp",dataType:"jsonp",success:function(t){e.meta=t,e.initMetadata()}})},MM.extend(cwm.layers.BingLayer,MM.Layer),cwm.layers.MapboxLayer=function(){return this instanceof cwm.layers.MapboxLayer?(this._tilejson={},this._url="",this._id="",this._composite=!0,this.name="",this.parent=document.createElement("div"),this.parent.style.cssText="position: absolute; top: 0px; left: 0px; width: 100%; height: 100%; margin: 0; padding: 0; z-index: 0",this.levels={},this.requestManager=new MM.RequestManager,this.requestManager.addCallback("requestcomplete",this.getTileComplete()),this.requestManager.addCallback("requesterror",this.getTileError()),this.setProvider(new wax.mm._provider({tiles:["data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"]})),void 0):new cwm.layers.MapboxLayer},mapbox.layer.prototype.refresh=function(t){var e=this;return wax.tilejson(this._url,function(n){e.tilejson(n),t&&t(e)}),this},mapbox.layer.prototype.url=function(t,e){return arguments.length?(this._mapboxhosting=0==t.indexOf(mapbox.MAPBOX_URL),this._url=t,this.refresh(e)):this._url},mapbox.layer.prototype.id=function(t,e){return arguments.length?(this.named(t),this._id=t,this.url(mapbox.MAPBOX_URL+t+".jsonp",e)):this._id},mapbox.layer.prototype.named=function(t){return arguments.length?(this.name=t,this):this.name},mapbox.layer.prototype.tilejson=function(t){if(!arguments.length)return this._tilejson;if(this._composite&&this._mapboxhosting||this.setProvider(new wax.mm._provider(t)),this._tilejson=t,this.name=this.name||t.id,this._id=this._id||t.id,t.bounds){var e=new MM.MercatorProjection(0,MM.deriveTransformation(-Math.PI,Math.PI,0,0,Math.PI,Math.PI,1,0,-Math.PI,-Math.PI,0,1));this.provider.tileLimits=[e.locationCoordinate(new MM.Location(t.bounds[3],t.bounds[0])).zoomTo(t.minzoom?t.minzoom:0),e.locationCoordinate(new MM.Location(t.bounds[1],t.bounds[2])).zoomTo(t.maxzoom?t.maxzoom:18)]}return this},mapbox.layer.prototype.draw=function(){if(this.enabled&&this.map){if(this._composite&&this._mapboxhosting){var t=0;for(t;this.map.layers.length>t&&this.map.layers[t]!=this;t++);for(var e=t-1;e>=0;e--)if(this.map.getLayerAt(e).enabled){if(this.map.getLayerAt(e)._composite)return this.parent.style.display="none",this.compositeLayer=!1,this;break}for(var n=[],o=t;this.map.layers.length>o;o++){var r=this.map.getLayerAt(o);if(r.enabled){if(!r._composite||!r._mapboxhosting)break;n.push(r.id())}}if(n=n.join(","),this.compositeLayer!==n){this.compositeLayer=n;var i=this;return wax.tilejson(mapbox.MAPBOX_URL+n+".jsonp",function(t){i.setProvider(new wax.mm._provider(t))}),this.parent.style.display="",this}}else this.parent.style.display="",this.compositeLayer&&(this.compositeLayer=!1,this.setProvider(new wax.mm._provider(this.tilejson())));return MM.Layer.prototype.draw.call(this)}},mapbox.layer.prototype.composite=function(t){return arguments.length?(this._composite=t?!0:!1,this):this._composite},mapbox.layer.prototype.enable=function(t){return MM.Layer.prototype.enable.call(this,t),this.map&&this.map.draw(),this},mapbox.layer.prototype.disable=function(t){return MM.Layer.prototype.disable.call(this,t),this.map&&this.map.draw(),this},MM.extend(mapbox.layer,MM.Layer),cwm.layers.FeatureLayer=function(t,e){var n,o=0,r=[],i=t.select("svg"),a=i.append("g"),s=d3.geo.transform({point:function(t,e){var n=l.map.locationPoint({lon:t,lat:e});this.stream.point(~~(.5+n.x),~~(.5+n.y))}}),u=d3.geo.path().projection(s),l={parent:t.node(),name:e,bounds:{},draw:function(){if(l.map&&n){var t=l.map.getZoom();return n.attr("d",u).style("fill-opacity",function(e){return.6*Math.min(Math.max(e.properties._maxZoom-t,0),1)}).classed("outline",function(e){return t>e.properties._maxZoom}),l}},add:function(t,e,i){e=e||{};var s=e.maxZoom||999,u=e.id||o++;return t.features.forEach(function(t){t.properties._maxZoom=s}),t.features.forEach(function(t){t.properties._id=u}),r=r.concat(t.features),l.bounds[u]=d3.geo.bounds(t),n=a.selectAll("path").data(r),n.enter().append("path").attr("class",u),i&&i(),l},load:function(t,e,n){return d3.json(t,function(o,r){if(o)throw o.response+": Could not load "+t;l.add(r,e,n)}),l},getLocations:function(t){var e=[];return n.each(function(n){e.push({id:cwm.util.sanitize(n.properties[t]),bounds:d3.geo.bounds(n)})}),e}};return l},cwm.layers.MarkerLayer=function(t,e){function n(t){var e=p.map.locationPoint({lon:t.geometry.coordinates[0],lat:t.geometry.coordinates[1]});return[~~(.5+e.x),~~(.5+e.y)]}function o(t,e){var n=p.map.getCenter(),o=t.geometry.coordinates,r=e.geometry.coordinates,i=Math.pow(o[0]-n.lon,2)+Math.pow(o[1]-n.lat,2),a=Math.pow(r[0]-n.lon,2)+Math.pow(r[1]-n.lat,2);return d3.ascending(i,a)}function r(){return!0}var i,a,s,u,l,c,d=t.select("svg"),m=d.append("g"),p={parent:t.node(),name:e,draw:function(){if(p.map&&i){var t=p.map.getZoom();if(i.attr("cx",function(t){return n(t)[0]}).attr("cy",function(t){return n(t)[1]}),c){var e=c.datum(),o=new MM.Point(n(e)[0],n(e)[1]);MM.moveElement(c.node(),o)}return a>s&&t>a?p.show():s>a&&a>t&&p.hide(),s=t,p}},add:function(t,e,n){return e=e||{},u=e.markerSize||8,a=e.minZoom||0,t.features.forEach(function(t){t.properties._markerSize=u}),p.bounds=d3.geo.bounds(t),i=cwm.render.Markers(t.features,m),l=cwm.handlers.MarkerInteraction(i),n&&n(),p},load:function(t,e,n){return d3.json(t,function(o,r){if(o)throw o.response+": Could not load "+t;p.add(r,e,n)}),p},getLocations:function(t,e){e=e||r;var n=[];return i.data().filter(e).forEach(function(e){var o=[[],[]];o[0][0]=o[1][0]=e.geometry.coordinates[0],o[0][1]=o[1][1]=e.geometry.coordinates[1],n.push({id:t(e),bounds:o})}),n},show:function(t){return t?i.transition().attr("r",0):t=r,i.filter(t||!0).sort(o).transition().duration(1e3).delay(function(t,e){return 10*e}).ease("elastic",2).attr("r",function(t){return t.properties._markerSize}),p},hide:function(){return p.show(function(){return!1}),p}};return p},cwm.handlers={},cwm.handlers.DragHandler=function(){function t(){e.parent.style.cursor="move",e.panBy(d3.event.dx,d3.event.dy)}var e,n={},o=d3.behavior.drag().on("drag",t).on("dragstart",function(){d3.event.sourceEvent.stopPropagation()}).on("dragend",function(){e.parent.style.cursor="auto"});return n.init=function(t){e=t,d3.select(e.parent).call(o)},n.remove=function(){d3.select(e.parent).on("mousedown.drag",null)},n},cwm.handlers.EaseHandler=function(){function t(){a=_.chain(a).map(function(t){var e=document.getElementById(t.id);return t.scrollPoint=e?e.offsetTop+e.offsetHeight:-1,t}).reject(function(t){return 0>t.scrollPoint}).sortBy("scrollPoint").value()}function e(){var t,e,n,o,s;i=[],_.forEach(a,function(a){e=r.centerFromBounds(a.bounds),o&&(t=mapbox.ease().map(r).from(o).to(e).easing("linear").setOptimalPath(),n=_.tail(t.future(a.scrollPoint-s+1)),i=i.concat(n)),o=e,s=a.scrollPoint})}function n(){var t=window.pageYOffset;return l?s==t?(requestAnimationFrame(n),!1):(s=t,u.easeTo(t),requestAnimationFrame(n),void 0):!1}var o,r,i,a,s,u={},l=!1;if(!mapbox.ease)throw"Mapbox easey library not found";return u.map=function(t){return r=t,u},u.locations=function(n){return arguments.length?(a=n,t(),r&&e(),u):a},u.enable=function(){if(s=0,l)return u;if(!a||!r)throw"Map and locations need to be set";return i||e(),l=!0,n(this),u},u.easeTo=function(t){return t=Math.max(t,0),o?t>o.top&&o.bottom>t?r.coordinate=o.easings[t-o.top]:o=void 0:r.coordinate=i[t]||_.last(i),r.draw(),u},u.getCoord=function(t){return t=Math.max(t,0),i[t]||_.last(i)},u.setOverride=function(t,e,n,a){t=t||r.coordinate.copy(),e=e||window.pageYOffset,n=Math.max(n||e-200,0),a=a||e+200;var s,l,c,d;return o={top:n,bottom:a},c=i[Math.floor(n)]||_.last(i),d=i[Math.floor(a)]||_.last(i),s=mapbox.ease().map(r).from(c).to(t).setOptimalPath(),l=mapbox.ease().map(r).from(t).to(d).setOptimalPath(),o.easings=s.future(e-n).concat(l.future(a-e)),o.time=s.getOptimalTime()+l.getOptimalTime(),u},u.clearOverride=function(){return o=void 0,u},u.getOverrideTime=function(){return Math.floor(o.time)},u},cwm.handlers.RevealHandler=function(){function t(){var e=[];return e.push.apply(e,arguments),M(e,t.prototype),e}function e(){this.origStyles={},this.length=0,this.wrapped={}}function n(t,e,n){var o,i,a,s,c,d,m=v(t);for(o=0;m.length>o;o++)i=b.add(m[o]),a=r.call(m[o],e,n),s=a[0],c=a[1],c>s&&c>0?(d=function(t,e){return function(n){return"opacity:"+l(Math.max(e-n,0)/(e-t)).toFixed(2)+";"}}(s,c),y.push([[s,c],i,d])):s>c&&s>0&&(d=function(t,e){return function(n){return"opacity:"+u(Math.min(n-e,t-e)/(t-e)).toFixed(2)+";"}}(s,c),y.push([[c,s],i,d]))}function o(){var t,e,n,o,r,i,a,s,u;for(x.length=0,n=x.add(cwm.util.fillArray([""],b.length)),t=0;f>t;t++){for(u=cwm.util.fillArray([""],b.length),e=!1,o=0;y.length>o;o++)r=y[o][0][0],i=y[o][0][1],a=y[o][1],s=y[o][2],t>=r&&i>t&&("function"==typeof s?u[a][1]=s:u[a][0]+=s,e=!0);e&&(n=x.add(u)),h[t]=n}}function r(t,e){return["function"==typeof t?t.call(this):t,"function"==typeof e?e.call(this):e]}function i(t){var e,n,o,r,i=h[Math.max(t,0)],a=x[i];for(e=0;a.length>e;e++){for(n=b[e],o=a[e][0],r=1;a[e].length>r;r++)o+=a[e][r].call(n,t);n.getAttribute("style")!==o&&n.setAttribute("style",o)}}function a(){var t=window.pageYOffset;return g?(d==t?w=requestAnimationFrame(a):(d=t,i(t),w=requestAnimationFrame(a)),void 0):!1}function s(t){return t?t.offsetTop+s(t.offsetParent):0}function u(t){return t*t}function l(t){return 1-u(1-t)}function c(t){for(var e,n=v(t),o=0;n.length>o;o++)""!==n[o].parentNode.getAttribute("data-wrap")&&(e=n[o].offsetHeight+"px",$(n[o]).wrapAll('<div data-wrap style="position: relative; height: '+e+'" />'))}var d,m={},p=window.innerHeight,f=document.body.scrollHeight,h=Array(f),y=[],g=!1,w=null,v=function(t){return document.querySelectorAll(t)};"function"==typeof Sizzle&&(v=function(t){return Sizzle(t)});var M={}.__proto__?function(t,e){t.__proto__=e}:function(t,e){for(var n in e)t[n]=e[n]};t.prototype=Object.create(Array.prototype),t.prototype.add=function(t){function e(t,n){if(!t||!n)return!1;if(t==n)return!0;if(t instanceof Array&&n instanceof Array){if(t.length!=n.length)return!1;for(var o=0;t.length>o;o++)if(t[o]instanceof Array&&n[o]instanceof Array){if(!e(t[o],n[o]))return!1}else if(t[o]!=n[o])return!1;return!0}return!1}for(var n=0;this.length>n;n++)if(e(this[n],t))return n;return this.push(t)-1},e.prototype.add=function(t){for(var e=0;this.length>e;e++)if(this[e]==t)return e;return this[e]=t,this.origStyles[e]=t.getAttribute("style"),this.length+=1,e};var b=new e,x=new t;return m.addClass=function(t,e,n,o){var i,a,s,u=v(t);for(i=0;u.length>i;i++)a=b.add(u[i]),s=r.call(u[i],n,o),s[1]>=0&&y.push([s,a,e+" "]);return m},m.affixTop=function(t,e,n){n=n||0;var o,r,i=function(){return s(this)-n};return c(t),e&&("function"==typeof e?(o=function(){return e.call(this)-n},r=function(){return e.call(this)-s(this)}):(o=function(){return e-n},r=function(){return e-s(this)}),m.addStyle(t,{position:"relative",top:r},o,999999)),m.addStyle(t,{position:"fixed",top:n,bottom:"auto"},i,o||999999),m},m.affixBottom=function(t,e,n){n=n||0;var o,r,i=function(){return s(this)-p+this.offsetHeight+n};return c(t),e&&("function"==typeof e?(o=function(){return e.call(this)-n},r=function(){return e.call(this)-s(this)+p-this.offsetHeight}):(o=function(){return e-n},r=function(){return e-s(this)}),m.addStyle(t,{position:"relative",top:r},0,o)),m.addStyle(t,{position:"fixed",bottom:n,top:"auto"},o||0,i),m},m.fadeIn=function(t,e,o){return n(t,o,e),m.addStyle(t,{opacity:0},0,e),m},m.fadeOut=function(t,e,o){return n(t,e,o),m.addStyle(t,{opacity:0},o,999999),m},m.addStyle=function(t,e,n,o){var i,a,s,u,l,c,d=v(t);for(i=0;d.length>i;i++)if(a=b.add(d[i]),s=r.call(d[i],n,o),c="",s[1]>=0){for(u in e)l="function"==typeof e[u]?e[u].call(d[i]):e[u],l+="number"==typeof l&&u.match(/top|bottom/)?"px":"",c+=u+":"+l+";";y.push([s,a,c])}return m},m.enable=function(){var t=performance.now();o();var e=performance.now();return console.log("caching took "+(e-t)+"ms"),g=!0,w&&cancelAnimationFrame(w),a(),m},m},cwm.handlers.MarkerInteraction=function(t){function e(){d3.select(this).transition().duration(500).ease("elastic",1.5).attr("r",function(t){return o(t,2)})}function n(){r||d3.select(this).transition().attr("r",o)}function o(t,e){return e=e||1,t.properties._markerSize*e}var r;t.on("mouseout.mi",n).on("mouseover.mi",e)}})();